# 📊 Epicourier 数据管道架构

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                   DATA PIPELINE ARCHITECTURE                    │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐
│ recipes.csv  │ (原始食谱数据 CSV)
│ - 500+ 行    │
│ - 食材/指标  │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│ STAGE 1: GEMINI AI PROCESSING                        │
│ (llama_recipe_pipeline.py)                           │
├──────────────────────────────────────────────────────┤
│ ✓ 缓存机制: 已处理不重复处理                         │
│ ✓ 重试机制: 3次重试失败才放弃                        │
│ ✓ JSON解析: 智能处理格式错误                         │
│ ⏱️  耗时: 30-60 分钟 (500+ 食谱)                     │
└──────┬───────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────┐
│   cache/ (JSON 缓存)         │
│ - 52768.json (食谱 ID)       │
│ - 52769.json                 │
│ - ...                        │
│ 包含:                        │
│ ├─ ingredients (食材数据)    │
│ ├─ recipe (食谱信息)         │
│ └─ map (食材映射)            │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│ STAGE 2: CSV CONVERSION                              │
│ (cache_to_csv.py)                                    │
├──────────────────────────────────────────────────────┤
│ ✓ 合并所有 JSON 文件                                 │
│ ✓ 去重食材 (name + unit)                             │
│ ✓ 生成关联映射 (recipes ↔ ingredients)               │
│ ✓ 提取标签 (从 strTags)                              │
│ ⏱️  耗时: < 1 分钟                                    │
└──────┬───────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────┐
│        5 CSV FILES (READY FOR IMPORT)           │
├─────────────────────────────────────────────────┤
│ 1. ingredients-supabase.csv                     │
│    - 247 行, 营养数据                           │
│                                                 │
│ 2. recipes-supabase.csv                         │
│    - 50 行, 食谱基本信息                        │
│                                                 │
│ 3. recipe_ingredient_map-supabase.csv           │
│    - 645 行, 食谱-食材关系                      │
│                                                 │
│ 4. tags-supabase.csv                            │
│    - 35 行, 标签信息                            │
│                                                 │
│ 5. recipe_tag_map-supabase.csv                  │
│    - 92 行, 食谱-标签关系                       │
└──────┬────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────┐
│ STAGE 3: DATABASE IMPORT                         │
│ (import_to_supabase.py)                          │
├──────────────────────────────────────────────────┤
│ ✓ 批量导入 (batch_size=100)                      │
│ ✓ Upsert 处理重复 (ignore_duplicates)            │
│ ✓ 逐行重试 (失败时)                              │
│ ✓ 导入顺序: 遵守外键约束                         │
│ ⏱️  耗时: 2-5 分钟                               │
└──────┬───────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────┐
│          SUPABASE DATABASE                       │
│          (PostgreSQL Local)                      │
├─────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌──────────────┐            │
│ │    Recipe       │ │  Ingredient  │            │
│ ├─────────────────┤ ├──────────────┤            │
│ │ id (PK)         │ │ id (PK)      │            │
│ │ name            │ │ name         │            │
│ │ description     │ │ unit         │            │
│ │ min_prep_time   │ │ calories_kcal│            │
│ │ green_score     │ │ protein_g    │            │
│ │ image_url       │ │ carbs_g      │            │
│ └────────┬────────┘ │ ... (14 nutrients)       │
│          │          └──────────────┘            │
│          │                 ▲                    │
│          │                 │                    │
│        1:N              1:N                     │
│          │                 │                    │
│          ▼                 ▼                    │
│   ┌──────────────────────────────────┐         │
│   │ Recipe-Ingredient_Map            │         │
│   ├──────────────────────────────────┤         │
│   │ recipe_id (FK) → Recipe          │         │
│   │ ingredient_id (FK) → Ingredient  │         │
│   │ relative_unit_100 (measure)      │         │
│   └──────────────────────────────────┘         │
│          ▲                                      │
│          │                                      │
│   ┌──────┴──────┐                              │
│   │             │                              │
│   │          ┌─────────────┐                   │
│   │          │  RecipeTag  │                   │
│   │          ├─────────────┤                   │
│   │          │ id (PK)     │                   │
│   │          │ name        │                   │
│   │          │ description │                   │
│   │          └─────┬───────┘                   │
│   │                │                           │
│   │              1:N                           │
│   │                │                           │
│   │                ▼                           │
│   │   ┌──────────────────────┐                │
│   │   │ Recipe-Tag_Map       │                │
│   │   ├──────────────────────┤                │
│   │   │ recipe_id (FK)       │                │
│   │   │ tag_id (FK)          │                │
│   │   └──────────────────────┘                │
│   │                                            │
│   └────────────────────────────────────────────┘
└─────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────┐
│          FRONTEND APPLICATION                   │
│          (http://localhost:3000)                │
├─────────────────────────────────────────────────┤
│ ✓ 推荐系统: 查询 Recipe + Ingredient             │
│ ✓ 营养追踪: 计算食材营养                        │
│ ✓ 日历管理: 管理 Calendar 条目                  │
│ ✓ 库存管理: 查询 Ingredient 库存                │
└─────────────────────────────────────────────────┘
```

---

## 数据转换详解

### Stage 1: JSON 生成

```json
输入 (CSV 行):
{
  "idMeal": "52768",
  "strMeal": "Arrabiata",
  "strInstructions": "Cook pasta...",
  "strIngredient1": "Tomato",
  "strMeasure1": "400g",
  ...
}

        ↓ Gemini 处理 ↓

输出 (JSON):
{
  "ingredients": [
    {
      "id": 1,
      "name": "Tomato",
      "unit": "g",
      "calories_kcal": 18,
      "protein_g": 0.88,
      ...
    }
  ],
  "recipe": {
    "id": 52768,
    "name": "Arrabiata",
    ...
  },
  "map": [
    {
      "id": 1,
      "recipe_id": 52768,
      "ingredient_id": 1,
      "relative_unit_100": 400
    }
  ]
}
```

### Stage 2: CSV 转换

```
所有 JSON → 合并 → 去重 → 映射 → 5个 CSV

┌─────────────────────────────────────────────┐
│ JSON 聚合逻辑                               │
├─────────────────────────────────────────────┤
│                                             │
│ Ingredients:                                │
│ ├─ ("Tomato", "g") → ID: 1                  │
│ ├─ ("Garlic", "clove") → ID: 2             │
│ └─ ... (自动分配 ID)                       │
│                                             │
│ Tags (从 strTags 提取):                     │
│ ├─ "Italian" → ID: 1                       │
│ ├─ "Pasta" → ID: 2                         │
│ └─ ... (自动分配 ID)                       │
│                                             │
│ Mappings (保持原始关系):                    │
│ ├─ Recipe 52768 → Ingredient 1 (400g)     │
│ ├─ Recipe 52768 → Tag 1 (Italian)         │
│ └─ ...                                      │
│                                             │
└─────────────────────────────────────────────┘
```

### Stage 3: 数据库导入

```
导入顺序 (解决外键依赖):

1️⃣  RecipeTag (tags)
    ← 无外键依赖
    ✓ 35 行导入完成

2️⃣  Ingredient (ingredients)
    ← 无外键依赖
    ✓ 247 行导入完成

3️⃣  Recipe (recipes)
    ← 无外键依赖
    ✓ 50 行导入完成

4️⃣  Recipe-Ingredient_Map
    ← FK: recipe_id → Recipe (✓ 已导入)
    ← FK: ingredient_id → Ingredient (✓ 已导入)
    ✓ 645 行导入完成

5️⃣  Recipe-Tag_Map
    ← FK: recipe_id → Recipe (✓ 已导入)
    ← FK: tag_id → RecipeTag (✓ 已导入)
    ✓ 92 行导入完成
```

---

## 文件依赖关系

```
┌─────────────────────────────────────────┐
│ 输入文件                                │
├─────────────────────────────────────────┤
│                                         │
│ recipes.csv                             │
│ ├─ llama_recipe_pipeline.py             │
│ │  ├─ 依赖: .env (GEMINI_API_KEY)      │
│ │  ├─ 依赖: prompts/*                  │
│ │  └─ 输出: cache/*.json               │
│ │           (自动创建目录)             │
│ │                                       │
│ ├─ cache_to_csv.py                      │
│ │  ├─ 输入: cache/*.json               │
│ │  ├─ 输入: recipes.csv (获取描述)    │
│ │  └─ 输出: *-supabase.csv              │
│ │           (在同目录)                 │
│ │                                       │
│ └─ import_to_supabase.py                │
│    ├─ 输入: *-supabase.csv              │
│    ├─ 依赖: Supabase (running)         │
│    └─ 输出: 数据库中的表               │
│                                         │
└─────────────────────────────────────────┘
```

---

## 缓存机制

```
首次运行:
  recipes.csv
       ↓
  llama_recipe_pipeline.py
       ├─ 检查 cache/52768.json → 不存在
       ├─ 调用 Gemini API
       ├─ 保存到 cache/52768.json ✓
       ├─ 检查 cache/52769.json → 不存在
       ├─ 调用 Gemini API
       ├─ 保存到 cache/52769.json ✓
       └─ ...

第二次运行 (增量更新):
  recipes.csv (新增 52770)
       ↓
  llama_recipe_pipeline.py
       ├─ 检查 cache/52768.json → 存在 ✓ 跳过
       ├─ 检查 cache/52769.json → 存在 ✓ 跳过
       ├─ 检查 cache/52770.json → 不存在
       ├─ 调用 Gemini API
       ├─ 保存到 cache/52770.json ✓
       └─ ...

好处:
  ✅ 节省 API 调用
  ✅ 快速增量更新
  ✅ 失败恢复简单
```

---

## 性能指标

```
处理 50 个食谱:

Stage 1 (Gemini):
  ├─ API 调用: 50
  ├─ 平均耗时: 2-4 秒/个
  └─ 总耗时: 100-200 秒 (2-3 分钟)
      * 首次运行
      * 缓存运行: < 1 秒

Stage 2 (CSV 转换):
  ├─ 文件读取: 50 JSON
  ├─ 合并操作: 1 次
  ├─ 去重: O(n)
  └─ 总耗时: < 1 秒

Stage 3 (导入):
  ├─ 表数: 5
  ├─ 总行数: 1099
  ├─ 批大小: 100
  ├─ 网络 RTT: ~50ms
  └─ 总耗时: 2-5 秒

完整流程: 35-70 分钟 (含 Gemini API 等待)
```

---

## 错误恢复

```
异常处理流程:

Gemini 调用失败
  ├─ Retry 1 (3秒 后)
  ├─ Retry 2 (3秒 后)
  ├─ Retry 3 (3秒 后)
  └─ 仍失败 → 抛出异常

JSON 解析失败
  ├─ 尝试标准解析
  ├─ 失败 → 尝试提取 JSON 子串
  ├─ 失败 → 保存原始响应
  └─ 记录警告并继续

导入失败
  ├─ 批量插入失败 → 逐行重试
  ├─ 单行失败 → 记录错误
  ├─ 继续处理其他行
  └─ 完成后报告错误摘要
```
